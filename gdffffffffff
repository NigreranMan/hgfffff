local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local humanoid = character:WaitForChild("Humanoid")

local collecting = false
local gui = nil
local countGui = nil
local bondsFolder = Workspace:WaitForChild("RuntimeItems")

-- ✅ **دالة `moveTo` لتحريك اللاعب بسلاسة نحو الهدف**
local function moveTo(humanoid, targetPoint, andThen)
    local targetReached = false
    local connection

    -- استماع لوصول الـ Humanoid إلى النقطة المطلوبة
    connection = humanoid.MoveToFinished:Connect(function(reached)
        targetReached = true
        connection:Disconnect()
        connection = nil
        if andThen then
            andThen(reached)
        end
    end)

    -- بدء المشي
    humanoid:MoveTo(targetPoint)

    -- تشغيل في ثريد منفصل حتى لا يوقف باقي السكربت
    task.spawn(function()
        while not targetReached do
            if not (humanoid and humanoid.Parent) then
                break
            end
            if humanoid.WalkToPoint ~= targetPoint then
                break
            end
            humanoid:MoveTo(targetPoint) -- تأكيد استمرار المشي
            task.wait(6) -- إعادة محاولة كل 6 ثوانٍ
        end

        if connection then
            connection:Disconnect()
            connection = nil
        end
    end)
end

-- 🔵 **إضافة تأثير Highlight على جميع الباوندات القريبة**
local function highlightBonds()
    for _, bond in pairs(bondsFolder:GetChildren()) do
        if bond:IsA("Model") and bond:FindFirstChild("HumanoidRootPart") then
            if not bond:FindFirstChild("Highlight") then
                local highlight = Instance.new("Highlight")
                highlight.Parent = bond
                highlight.FillColor = Color3.fromRGB(255, 255, 0)
                highlight.FillTransparency = 0.7
                highlight.OutlineTransparency = 1
            end
        end
    end
end

-- 🔵 **حساب عدد الباوندات وتحديث الـ GUI**
local function updateBondCountGUI()
    if not countGui then
        countGui = Instance.new("ScreenGui", player:FindFirstChildOfClass("PlayerGui"))
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.2, 0, 0.05, 0)
        label.Position = UDim2.new(0.4, 0, 0.05, 0)
        label.BackgroundTransparency = 0.5
        label.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextScaled = true
        label.Text = "Bonds: 0"
        label.Parent = countGui
    end

    local bondCount = #bondsFolder:GetChildren()
    countGui.TextLabel.Text = "Bonds: " .. bondCount
end

-- 🔵 **إيجاد جميع الباوندات القريبة باستمرار**
local function findNearbyBonds()
    local nearbyBonds = {}

    for _, bond in pairs(bondsFolder:GetChildren()) do
        if bond:IsA("Model") and bond:FindFirstChild("HumanoidRootPart") then
            local distance = (humanoidRootPart.Position - bond.HumanoidRootPart.Position).Magnitude
            if distance <= 500 then
                table.insert(nearbyBonds, bond)
            end
        end
    end

    return nearbyBonds
end

-- 🔵 **إظهار GUI عند العثور على باوند قريب**
local function showCollectGUI()
    if not gui then
        gui = Instance.new("ScreenGui", player:FindFirstChildOfClass("PlayerGui"))
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.4, 0, 0.1, 0)
        label.Position = UDim2.new(0.3, 0, 0.4, 0)
        label.BackgroundTransparency = 0.3
        label.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextScaled = true
        label.Text = "تم العثور على باوند، اضغط E لجمعه"
        label.Parent = gui
    end
end

-- 🔵 **إخفاء GUI**
local function hideCollectGUI()
    if gui then
        gui:Destroy()
        gui = nil
    end
end

-- 🔵 **التحرك نحو الباوند ثم استلامه باستخدام `moveTo`**
local function moveToAndCollect(bond)
    if collecting then return end
    collecting = true

    local bondPosition = bond.HumanoidRootPart.Position
    moveTo(humanoid, bondPosition, function(reached)
        if reached then
            local args = {
                [1] = bond
            }
            ReplicatedStorage:WaitForChild("Packages"):WaitForChild("RemotePromise"):WaitForChild("Remotes"):WaitForChild("C_ActivateObject"):FireServer(unpack(args))
            wait(0.5) -- تأخير قبل العودة للبحث عن الباوند التالي
            collecting = false
        end
    end)
end

-- 🔵 **التحقق المستمر عن الباوندات القريبة وتحديث الـ GUI**
local function checkAndCollectBonds()
    while true do
        -- التحقق المستمر عن الباوندات القريبة
        local nearbyBonds = findNearbyBonds()

        -- إذا تم العثور على باوند، إظهار الـ GUI
        if #nearbyBonds > 0 and not gui then
            showCollectGUI()
        end

        -- إذا ضغط اللاعب على E، يتم التوجه لجمع الباوندات
        if UserInputService:IsKeyDown(Enum.KeyCode.E) then
            for _, bond in pairs(nearbyBonds) do
                moveToAndCollect(bond)
            end
        end

        -- تحديث عداد الباوندات في الـ GUI
        updateBondCountGUI()

        -- انتظار بين التحديثات
        wait(1)
    end
end

-- بدأ عملية البحث المستمر عن الباوندات
task.spawn(checkAndCollectBonds)
